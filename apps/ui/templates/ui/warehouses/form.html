{% extends "ui/base.html" %}
{% block title %}Almacén | Control de Inventarios{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-1">{% if object %}Editar almacén{% else %}Nuevo almacén{% endif %}</h1>
      <div class="text-secondary">Primero elige el cliente y luego la sucursal</div>
    </div>
    <a class="btn btn-outline-dark btn-sm" href="{% url 'ui:warehouses_list' %}">Volver</a>
  </div>

  <div class="card p-4 shadow-sm">
    <form method="post" novalidate id="warehouse-form">
      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">{{ form.customer.label }}</label>
          {{ form.customer }}
          {% for e in form.customer.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label">{{ form.branch.label }}</label>
          {{ form.branch }}
          {% for e in form.branch.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label">{{ form.name.label }}</label>
          {{ form.name }}
          {% for e in form.name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label">{{ form.code.label }}</label>
          {{ form.code }}
          {% for e in form.code.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12">
          <label class="form-label">{{ form.address.label }}</label>
          {{ form.address }}
          {% for e in form.address.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12">
          <div class="form-check">
            {{ form.is_active }}
            <label class="form-check-label">{{ form.is_active.label }}</label>
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-dark" type="submit">Guardar</button>
          <a class="btn btn-outline-secondary" href="{% url 'ui:warehouses_list' %}">Cancelar</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    const customer = document.querySelector('select[name="customer"]');
    const branch = document.querySelector('select[name="branch"]');

    function setOptions(select, items, placeholder, selectedValue = "") {
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder;
      select.appendChild(opt);

      for (const it of items) {
        const o = document.createElement('option');
        o.value = it.id;
        o.textContent = it.name;
        if (String(it.id) === String(selectedValue)) o.selected = true;
        select.appendChild(o);
      }
    }

    async function loadBranches() {
      const id = customer.value;
      const current = branch.value;
      setOptions(branch, [], 'Selecciona sucursal');
      if (!id) return;

      const r = await fetch(`/ui/branches/?customer_id=${id}`);
      const j = await r.json();
      setOptions(branch, j.results, 'Selecciona sucursal', current);
    }

    customer.addEventListener('change', loadBranches);

    // Si estás editando, customer ya tiene valor y branch debe cargarse.
    if (customer.value) loadBranches();
  </script>
{% endblock %}
